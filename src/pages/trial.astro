---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.tsx";
import Footer from "../components/Footer.astro";
import { site } from "../lib/seo";

// Safely obtain the current request URL and parse query params.
// Astro.request.url can be absolute (https://...) or relative (/trial?...).
// Use `site` as base when needed so query params are preserved.
let requestUrlRaw = '';
if (typeof Astro !== 'undefined' && (Astro as any).request && (Astro as any).request.url) {
  requestUrlRaw = (Astro as any).request.url;
}

// Default to absolute trial URL if we still don't have one
if (!requestUrlRaw) requestUrlRaw = `${site}/trial`;

let urlObj: URL;
try {
  // If requestUrlRaw is relative (starts with '/'), provide base so URL parsing keeps querystring
  if (/^\//.test(requestUrlRaw)) {
    urlObj = new URL(requestUrlRaw, site);
  } else {
    urlObj = new URL(requestUrlRaw);
  }
} catch (e) {
  urlObj = new URL(`${site}/trial`);
}

let name = urlObj.searchParams.get("name") || "";
name = name.replace(/\+/g, " ").trim();
if (name.startsWith("@")) name = name.slice(1).trim();
// Fallback
const displayName = name || "Teman WithLia";
---

<BaseLayout title={`Withlia Trial — ${displayName}`} url={`${site}/trial`}>
  <NavBar client:idle />

  <main class="min-h-screen flex items-center justify-center py-24">
    <div class="container-w max-w-2xl rounded-2xl border border-black/10 bg-white p-10 shadow-xl text-center">
      <img src="/withlia-logo.svg" alt="WithLia" class="mx-auto mb-4 h-8 w-auto" />

      <p class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-white/80 text-black/70 border border-black/10 mb-4">
        WithLia Trial
      </p>

      <h1 class="text-3xl font-extrabold leading-tight md:text-4xl">
        Congrats, <span id="trial-name">{displayName}</span>!
      </h1>

      <p class="mt-4 text-base text-black/70">Selamat, trial WithLia kamu sudah aktif. Berikut beberapa sumber untuk memulai.</p>

      <div class="mt-8 flex flex-col gap-3 sm:flex-row sm:justify-center">
        <a href="https://drive.google.com/file/d/1g4BNQXCfsnSSmfJ-2TNXP0BwZoUb5eIS/view?usp=sharing" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-[var(--orange)] px-5 py-3 font-semibold text-white shadow-card hover:opacity-95" target="_blank" rel="noopener noreferrer">
          Download WithLia Trial Playbook
        </a>

        <a href="https://chatgpt.com/g/g-685fa16a2570819186216fac4842a0ea-lily-sahabat-marketer" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border-2 border-[var(--blue)] px-5 py-3 font-semibold text-[var(--blue)] hover:bg-[var(--blue)] hover:text-white" target="_blank" rel="noopener noreferrer">
          GPTs Free Version
        </a>
      </div>

      <p class="mt-6 text-sm text-black/60">Butuh bantuan? Balas email konfirmasi atau buka fitur Coba Gratis di situs.</p>
    </div>
  </main>

  <script>
    // Client-side enhancement: read `name` from query string and replace the placeholder.
    (function () {
      try {
        const params = new URLSearchParams(window.location.search || '');
        let n = params.get('name') || '';
        n = decodeURIComponent(n.replace(/\+/g, ' ')).trim();
        if (n.startsWith('@')) n = n.slice(1).trim();
        if (n) {
          const el = document.getElementById('trial-name');
          if (el) el.textContent = n;
          // update title to match
          document.title = `Withlia Trial — ${n}`;
        }
      } catch (e) {
        // no-op on errors
      }
    })();
  </script>

  <Footer />
</BaseLayout>
